export const title = "Cloudflare 服务对比：KV、D1、R2、Queues";

# {title}

## 一个核心比喻：搭建一个现代化的数字工作室

您可以把您用 Vite 开发的应用想象成一个工作室的前台接待区（这是您的静态网站），而 Cloudflare 的这些服务，则是工作室后台的各种高效设施。您作为老板，不需要自己去买服务器盖大楼，而是按需租用这些设施。

- KV (Workers KV)：工作室墙上的便签板/白板
- D1：工作室的中央档案柜
- R2：工作室的储藏仓库
- Queues (Workers Queues)：工作室的任务委派箱

下面我们逐一拆解这个比喻。

## KV (Workers KV) - 便签板/白板

一句话概括：一个全球分布的、读取超快的键值对（Key-Value）数据库。

### 核心特点

- 读取极快：数据被缓存在离用户最近的边缘节点，所以读取延迟极低。
- 最终一致性：您在一处"写"上一张新便签，它需要一点时间（通常是秒级）才能同步到全球所有地方的"便签板"上。所以，它不保证您刚写完，全世界立刻就能看到最新的。
- 结构简单：只能通过一个"键"（Key）去获取一个"值"（Value），不能进行复杂的查询。

### 适合做什么（便签板/白板的用途）

- 存放网站配置：比如网站的标题、功能开关（A/B 测试）。这些信息需要快速读取，但不常改变。
- 存放访问令牌或会话：验证用户身份的临时信息。
- 缓存 API 响应：对于一些不常变化但请求频繁的公开API数据，可以缓存结果，下次直接从KV读取，不用再请求源API。

### 不适合做什么

- 存放需要强一致性的核心业务数据（比如用户余额、订单状态）。
- 需要复杂查询、排序或关联的数据。

## D1 - 中央档案柜

一句话概括：一个基于 SQLite 的标准关系型数据库（SQL 数据库）。

### 核心特点

- 强一致性与事务：这是真正的数据库。您对档案柜的操作（比如同时修改用户表和订单表）要么全部成功，要么全部失败（事务），保证数据不会出错。
- 结构化：数据存储在规范的表格（Table）里，有行有列，可以定义字段类型、索引，就像档案柜里分门别类的文件夹。
- 支持 SQL 查询：您可以使用强大的 SQL 语言进行复杂的查询、筛选、排序和关联。

### 适合做什么（档案柜的用途）

- 核心业务数据：用户信息、文章内容、商品列表、订单记录等。
- 任何需要数据完整性、准确性和复杂查询的场景。

### 不适合做什么

- 存储非常大的二进制文件（比如高清视频）。
- 追求像 KV 那样极致的全球边缘读取速度（D1 数据库本身位于特定区域，虽然访问也很快，但物理距离上不如 KV 的边缘缓存极致）。

## R2 - 储藏仓库

一句话概括：一个用于存储大文件（对象）的云存储服务，类似 Amazon S3。

### 核心特点

- 为大文件优化：专门设计用来存放图片、视频、音频、PDF、ZIP 压缩包等任何形式的文件。
- 高性价比：存储成本低，尤其是 Cloudflare R2 的一大卖点是无出口带宽费用，这意味着用户从 R2 下载文件，您不需要支付额外的流量费。
- 非结构化：它就像一个大仓库，您把东西（文件）放进去，得到一个地址（Key），下次凭地址来取。您不能对文件内容进行 SQL 查询。

### 适合做什么（仓库的用途）

- 用户上传的内容：用户头像、发布的图片、上传的附件。
- 网站的静态资源：JS/CSS 文件、字体、背景图片等（虽然 Cloudflare Pages 已经帮您托管了，但如果您有独立的媒体站，R2 很合适）。
- 数据备份和归档。

### 不适合做什么

- 存放需要频繁更新和查询的结构化数据（那是 D1 的活）。

## Queues (Workers Queues) - 任务委派箱

一句话概括：一个实现异步任务处理的消息队列。

### 核心特点

- 解耦和异步：当有一个耗时的任务时，您不需要让用户一直等着。您只需写一张"任务卡"扔进"委派箱"，然后立刻告诉用户"我已经收到您的请求，正在处理"。
- 可靠性：系统会自动确保"委派箱"里的任务最终会被某个 Worker 执行。如果执行失败，它会自动重试。
- 削峰填谷：如果瞬间有大量任务涌入（比如搞活动时大量用户下单），Queues 可以作为缓冲，让后台 Worker按照自己的节奏平稳处理，防止系统崩溃。

### 适合做什么（任务委派箱的用途）

- 发送电子邮件/通知：用户注册后，将"发送欢迎邮件"的任务放入队列。
- 图片/视频处理：用户上传一张原图到 R2 后，将"生成不同尺寸缩略图"的任务放入队列。
- 调用第三方 API：需要与外部服务同步数据时，通过队列异步进行。

### 不适合做什么

- 需要立即得到结果的同步操作。

## 总结与组合拳：一个实际场景

假设您的应用有一个功能：用户更新个人资料，包括修改昵称和上传新头像。

- 用户在您的 Vite 应用界面点击"保存"。请求发送到您的 Cloudflare Function。
- Function 接收到请求，它会：
  - 将新头像文件上传到 R2（储藏仓库），并获取到文件的唯一 Key。
  - 执行一条 SQL 语句，更新 D1（档案柜）中对应用户的 `nickname` 和 `avatar_key` 字段。这是一个事务操作，保证数据一致。
  - 如果用户的公开个人资料页被缓存在 KV（便签板）中，那么现在需要将这个缓存删除，以便下次访问时能从 D1 获取最新信息。
  - 向 Queues（任务委派箱）发送一个消息，内容是："为这个新头像生成缩略图"。
- Function 立刻向前端返回成功信息，用户界面显示"保存成功"。用户完全感觉不到后台还在忙。
- 稍后，一个后台 Worker 从 Queues 中取出任务，从 R2 下载原图，生成缩略图，再上传回 R2。

### 通过这个例子，您可以看到：

- D1 是您业务数据的核心和真相源头。
- R2 负责处理笨重的"物件"（文件）。
- KV 是为了让热门数据被更快地访问而设置的"快捷方式"。
- Queues 确保了耗时但不紧急的工作不会阻塞主要流程，提升了用户体验。

## 服务对比表

| 服务 | 类型 | 主要用途 | 数据一致性 | 读取速度 | 适合存储 |
|------|------|---------|-----------|---------|---------|
| KV | 键值存储 | 缓存、配置 | 最终一致 | 极快（边缘） | 配置、令牌、缓存 |
| D1 | SQL数据库 | 核心业务 | 强一致 | 快 | 用户数据、订单、文章 |
| R2 | 对象存储 | 文件存储 | 强一致 | 快 | 图片、视频、文件 |
| Queues | 消息队列 | 异步任务 | 可靠传递 | - | 邮件、处理任务、通知 |


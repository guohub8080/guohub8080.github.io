export const title = "Express.js 入门指南";

# {title}

Express.js 是 Node.js 最流行的 Web 应用框架，以其简洁、灵活和强大而闻名。本文将介绍 Express.js 的核心概念和基本使用。

## 什么是 Express.js？

Express.js 是一个快速、开放、极简的 Node.js Web 应用框架，提供了一系列强大的功能来开发 Web 和移动应用。

### 核心特点

- 简洁灵活：最小化的核心功能，易于扩展
- 路由系统：强大的路由机制
- 中间件：基于中间件的架构
- 模板引擎：支持多种模板引擎
- 性能优异：轻量级，执行效率高
- 社区强大：丰富的第三方中间件生态

### 适用场景

- RESTful API 服务
- 单页应用（SPA）后端
- 传统的服务端渲染应用
- 微服务架构
- 实时应用（配合 Socket.io）

## 安装和快速开始

### 创建项目

```bash
# 创建项目目录
mkdir my-express-app
cd my-express-app

# 初始化 npm 项目
npm init -y

# 安装 Express
npm install express

# 安装开发依赖
npm install -D typescript @types/node @types/express ts-node nodemon
```

### TypeScript 配置

创建 `tsconfig.json`：

```json
{
  "compilerOptions": {
    "target": "ES2020",
    "module": "commonjs",
    "lib": ["ES2020"],
    "outDir": "./dist",
    "rootDir": "./src",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true,
    "resolveJsonModule": true,
    "moduleResolution": "node"
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules"]
}
```

### 配置 package.json

```json
{
  "name": "my-express-app",
  "version": "1.0.0",
  "scripts": {
    "dev": "nodemon --exec ts-node src/index.ts",
    "build": "tsc",
    "start": "node dist/index.js"
  },
  "dependencies": {
    "express": "^4.18.2"
  },
  "devDependencies": {
    "@types/express": "^4.17.21",
    "@types/node": "^20.10.0",
    "nodemon": "^3.0.2",
    "ts-node": "^10.9.2",
    "typescript": "^5.3.3"
  }
}
```

### 第一个 Express 应用

创建 `src/index.ts`：

```typescript
import express, { Request, Response } from 'express';

const app = express();
const PORT = 3000;

// 中间件：解析 JSON
app.use(express.json());

// 基础路由
app.get('/', (req: Request, res: Response) => {
  res.json({ message: 'Hello Express!' });
});

// 启动服务器
app.listen(PORT, () => {
  console.log(`Server is running on http://localhost:${PORT}`);
});
```

运行应用：

```bash
npm run dev
```

访问 `http://localhost:3000`，你会看到 JSON 响应。

## 路由系统

Express 提供了灵活的路由机制。

### 基础路由

```typescript
import express, { Request, Response } from 'express';

const app = express();

// GET 请求
app.get('/users', (req: Request, res: Response) => {
  res.json({ users: [] });
});

// POST 请求
app.post('/users', (req: Request, res: Response) => {
  const { name, email } = req.body;
  res.status(201).json({ message: 'User created', data: { name, email } });
});

// PUT 请求
app.put('/users/:id', (req: Request, res: Response) => {
  const { id } = req.params;
  res.json({ message: `User ${id} updated` });
});

// DELETE 请求
app.delete('/users/:id', (req: Request, res: Response) => {
  const { id } = req.params;
  res.json({ message: `User ${id} deleted` });
});
```

### 路由参数

```typescript
// URL 参数
app.get('/users/:id', (req: Request, res: Response) => {
  const userId = req.params.id;
  res.json({ userId });
});

// 多个参数
app.get('/posts/:postId/comments/:commentId', (req: Request, res: Response) => {
  const { postId, commentId } = req.params;
  res.json({ postId, commentId });
});

// 查询参数
app.get('/search', (req: Request, res: Response) => {
  const { q, page, limit } = req.query;
  res.json({ query: q, page, limit });
});
```

### 路由模块化

创建 `src/routes/users.ts`：

```typescript
import express, { Request, Response } from 'express';

const router = express.Router();

// GET /api/users
router.get('/', (req: Request, res: Response) => {
  res.json({ users: [] });
});

// GET /api/users/:id
router.get('/:id', (req: Request, res: Response) => {
  const { id } = req.params;
  res.json({ id, name: 'John Doe' });
});

// POST /api/users
router.post('/', (req: Request, res: Response) => {
  const user = req.body;
  res.status(201).json({ message: 'User created', data: user });
});

export default router;
```

在 `src/index.ts` 中使用：

```typescript
import express from 'express';
import userRoutes from './routes/users';

const app = express();

app.use(express.json());

// 挂载路由
app.use('/api/users', userRoutes);

app.listen(3000);
```

## 中间件

中间件是 Express 的核心概念，用于处理请求和响应。

### 内置中间件

```typescript
import express from 'express';

const app = express();

// 解析 JSON 请求体
app.use(express.json());

// 解析 URL-encoded 请求体
app.use(express.urlencoded({ extended: true }));

// 提供静态文件
app.use(express.static('public'));
```

### 自定义中间件

```typescript
import { Request, Response, NextFunction } from 'express';

// 日志中间件
const logger = (req: Request, res: Response, next: NextFunction) => {
  const timestamp = new Date().toISOString();
  console.log(`[${timestamp}] ${req.method} ${req.url}`);
  next();
};

// 认证中间件
const authenticate = (req: Request, res: Response, next: NextFunction) => {
  const token = req.headers.authorization;
  
  if (!token) {
    return res.status(401).json({ error: 'Unauthorized' });
  }
  
  // 验证 token（简化示例）
  if (token !== 'Bearer valid-token') {
    return res.status(403).json({ error: 'Forbidden' });
  }
  
  next();
};

// 使用中间件
app.use(logger);
app.use('/api/protected', authenticate);
```

### 错误处理中间件

```typescript
import { Request, Response, NextFunction } from 'express';

// 错误处理中间件（必须有 4 个参数）
const errorHandler = (
  err: Error,
  req: Request,
  res: Response,
  next: NextFunction
) => {
  console.error('Error:', err.message);
  
  res.status(500).json({
    error: 'Internal Server Error',
    message: err.message
  });
};

// 必须在所有路由之后注册
app.use(errorHandler);
```

### 中间件执行顺序

```typescript
import express from 'express';

const app = express();

// 1. 全局中间件
app.use((req, res, next) => {
  console.log('Global middleware');
  next();
});

// 2. 路由级中间件
app.use('/api', (req, res, next) => {
  console.log('API middleware');
  next();
});

// 3. 路由处理
app.get('/api/users', (req, res) => {
  res.json({ users: [] });
});

// 4. 错误处理中间件
app.use((err, req, res, next) => {
  res.status(500).json({ error: err.message });
});
```

## 请求和响应

### 请求对象（Request）

```typescript
app.get('/demo', (req: Request, res: Response) => {
  // URL 参数
  const id = req.params.id;
  
  // 查询参数
  const query = req.query;
  
  // 请求体
  const body = req.body;
  
  // 请求头
  const contentType = req.headers['content-type'];
  const userAgent = req.get('User-Agent');
  
  // 其他信息
  const method = req.method;
  const path = req.path;
  const url = req.url;
  const ip = req.ip;
  
  res.json({ id, query, body, contentType, method, path });
});
```

### 响应对象（Response）

```typescript
app.get('/response-demo', (req: Request, res: Response) => {
  // 发送 JSON
  res.json({ message: 'Success' });
  
  // 设置状态码
  res.status(201).json({ created: true });
  
  // 发送文本
  res.send('Hello World');
  
  // 重定向
  res.redirect('/new-url');
  
  // 设置响应头
  res.set('X-Custom-Header', 'value');
  
  // 下载文件
  res.download('/path/to/file.pdf');
  
  // 发送文件
  res.sendFile('/path/to/file.html');
});
```

## 实战示例：完整的 REST API

```typescript
import express, { Request, Response, NextFunction } from 'express';

const app = express();
app.use(express.json());

// 模拟数据库
interface User {
  id: number;
  name: string;
  email: string;
}

let users: User[] = [
  { id: 1, name: 'Alice', email: 'alice@example.com' },
  { id: 2, name: 'Bob', email: 'bob@example.com' }
];

let nextId = 3;

// 获取所有用户
app.get('/api/users', (req: Request, res: Response) => {
  const { page = '1', limit = '10' } = req.query;
  const pageNum = parseInt(page as string);
  const limitNum = parseInt(limit as string);
  
  const start = (pageNum - 1) * limitNum;
  const end = start + limitNum;
  
  const paginatedUsers = users.slice(start, end);
  
  res.json({
    data: paginatedUsers,
    page: pageNum,
    limit: limitNum,
    total: users.length
  });
});

// 获取单个用户
app.get('/api/users/:id', (req: Request, res: Response) => {
  const id = parseInt(req.params.id);
  const user = users.find(u => u.id === id);
  
  if (!user) {
    return res.status(404).json({ error: 'User not found' });
  }
  
  res.json(user);
});

// 创建用户
app.post('/api/users', (req: Request, res: Response) => {
  const { name, email } = req.body;
  
  // 验证
  if (!name || !email) {
    return res.status(400).json({ error: 'Name and email are required' });
  }
  
  // 检查邮箱是否已存在
  if (users.some(u => u.email === email)) {
    return res.status(409).json({ error: 'Email already exists' });
  }
  
  const newUser: User = {
    id: nextId++,
    name,
    email
  };
  
  users.push(newUser);
  res.status(201).json(newUser);
});

// 更新用户
app.put('/api/users/:id', (req: Request, res: Response) => {
  const id = parseInt(req.params.id);
  const { name, email } = req.body;
  
  const userIndex = users.findIndex(u => u.id === id);
  
  if (userIndex === -1) {
    return res.status(404).json({ error: 'User not found' });
  }
  
  if (name) users[userIndex].name = name;
  if (email) users[userIndex].email = email;
  
  res.json(users[userIndex]);
});

// 删除用户
app.delete('/api/users/:id', (req: Request, res: Response) => {
  const id = parseInt(req.params.id);
  const userIndex = users.findIndex(u => u.id === id);
  
  if (userIndex === -1) {
    return res.status(404).json({ error: 'User not found' });
  }
  
  users.splice(userIndex, 1);
  res.status(204).send();
});

// 404 处理
app.use((req: Request, res: Response) => {
  res.status(404).json({ error: 'Not found' });
});

// 错误处理
app.use((err: Error, req: Request, res: Response, next: NextFunction) => {
  console.error(err.stack);
  res.status(500).json({ error: 'Internal server error' });
});

const PORT = 3000;
app.listen(PORT, () => {
  console.log(`Server running on http://localhost:${PORT}`);
});
```

## 常用中间件库

### CORS

```bash
npm install cors
npm install -D @types/cors
```

```typescript
import cors from 'cors';

// 允许所有来源
app.use(cors());

// 自定义配置
app.use(cors({
  origin: 'http://localhost:3000',
  methods: ['GET', 'POST'],
  credentials: true
}));
```

### 请求日志：Morgan

```bash
npm install morgan
npm install -D @types/morgan
```

```typescript
import morgan from 'morgan';

// 开发环境日志
app.use(morgan('dev'));

// 组合格式
app.use(morgan('combined'));
```

### 安全头：Helmet

```bash
npm install helmet
```

```typescript
import helmet from 'helmet';

app.use(helmet());
```

### 请求限流：Express Rate Limit

```bash
npm install express-rate-limit
```

```typescript
import rateLimit from 'express-rate-limit';

const limiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 分钟
  max: 100 // 最多 100 个请求
});

app.use('/api/', limiter);
```

## 环境变量配置

```bash
npm install dotenv
```

创建 `.env` 文件：

```
PORT=3000
NODE_ENV=development
DATABASE_URL=postgresql://localhost:5432/mydb
JWT_SECRET=your-secret-key
```

使用环境变量：

```typescript
import dotenv from 'dotenv';

dotenv.config();

const PORT = process.env.PORT || 3000;
const isDevelopment = process.env.NODE_ENV === 'development';

app.listen(PORT, () => {
  console.log(`Server running on port ${PORT}`);
});
```

## 最佳实践

1. 使用 TypeScript 提供类型安全
2. 模块化路由和控制器
3. 统一的错误处理
4. 使用环境变量管理配置
5. 添加日志记录
6. 实现请求验证
7. 使用 CORS 和安全中间件
8. 实现请求限流
9. 编写单元测试
10. 使用 ESLint 和 Prettier

## 项目结构建议

```
src/
├── controllers/      # 控制器
│   └── userController.ts
├── routes/          # 路由
│   └── users.ts
├── middlewares/     # 中间件
│   ├── auth.ts
│   └── errorHandler.ts
├── models/          # 数据模型
│   └── User.ts
├── services/        # 业务逻辑
│   └── userService.ts
├── utils/           # 工具函数
│   └── validation.ts
├── config/          # 配置
│   └── database.ts
└── index.ts         # 入口文件
```

## 总结

Express.js 是构建 Node.js Web 应用的理想选择，具有以下优势：
- 简洁易学，上手快
- 灵活可扩展
- 强大的路由和中间件系统
- 丰富的生态系统
- 适合各种规模的应用

在下一篇文章中，我们将学习如何使用 Sequelize ORM 来操作数据库。

## 相关资源

- [Express.js 官方文档](https://expressjs.com/)
- [Express.js GitHub](https://github.com/expressjs/express)
- [Node.js 官方文档](https://nodejs.org/)
- [TypeScript 官方文档](https://www.typescriptlang.org/)


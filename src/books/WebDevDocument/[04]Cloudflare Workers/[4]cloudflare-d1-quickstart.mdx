export const title = "Cloudflare Workers 快速开始与 D1 数据库";

# {title}

本文介绍如何使用 Cloudflare CLI 快速创建项目，以及如何配置和使用 D1 数据库。

## 使用 pnpm 创建项目

Cloudflare 提供了官方脚手架工具，可以快速创建各种类型的 Workers 项目。

### 创建新项目

```bash
# 使用 pnpm 创建项目
pnpm create cloudflare@latest my-api

# 或使用 npm
npm create cloudflare@latest my-api

# 或使用 yarn
yarn create cloudflare@latest my-api
```

### 交互式选项

运行命令后会出现交互式选项：

```
╭ Create an application with Cloudflare
│
├ In which directory do you want to create your application?
│ dir ./my-api
│
├ What type of application do you want to create?
│ ● "Hello World" Worker
│ ○ "Hello World" Worker (Python)
│ ○ "Hello World" Durable Object
│ ○ Website or web app
│ ○ Example router & proxy Worker
│ ○ Scheduled Worker (Cron Trigger)
│ ○ Queue consumer & producer Worker
│ ○ API starter (OpenAPI compliant)
│
├ Do you want to use TypeScript?
│ Yes
│
├ Do you want to use git for version control?
│ Yes
│
╰ Do you want to deploy your application?
  ○ Yes / ● No
```

### 推荐选择

```
类型：选择 "Hello World" Worker 或 "API starter"
TypeScript：Yes（推荐）
Git：Yes
部署：No（先本地开发和测试）
```

### 项目结构

创建后的项目结构：

```
my-api/
├── src/
│   └── index.ts          # Worker 主文件
├── test/
│   └── index.spec.ts     # 测试文件
├── wrangler.toml         # Wrangler 配置文件
├── tsconfig.json         # TypeScript 配置
├── package.json          # 依赖配置
└── vitest.config.ts      # 测试配置
```

### 初始代码示例

生成的 `src/index.ts` 文件：

```typescript
export interface Env {
  // 环境变量类型定义
}

export default {
  async fetch(request: Request, env: Env, ctx: ExecutionContext): Promise<Response> {
    return new Response('Hello World!');
  },
};
```

## D1 数据库入门

D1 是 Cloudflare 的无服务器 SQL 数据库，基于 SQLite，在边缘网络运行。

### D1 的优势

- 全球分布：数据存储在多个数据中心
- 低延迟：靠近用户的位置读取数据
- SQL 兼容：支持标准 SQL 语法
- 自动备份：内置数据备份和恢复
- 无服务器：按使用量付费，无需管理服务器

### 创建 D1 数据库

```bash
# 创建数据库
wrangler d1 create mydb

# 输出示例：
✅ Successfully created DB 'mydb' in region APAC
Created your database using D1's new storage backend.

[[d1_databases]]
binding = "DB" # 可用于 Workers 代码中的变量名
database_name = "mydb"
database_id = "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
```

### 配置 wrangler.toml

将输出的配置添加到 `wrangler.toml` 文件：

```toml
name = "my-api"
main = "src/index.ts"
compatibility_date = "2024-01-01"

# D1 数据库配置
[[d1_databases]]
binding = "DB"              # Worker 中使用的变量名
database_name = "mydb"      # 数据库名称
database_id = "your-database-id-here"  # 从 create 命令输出复制
```

### 初始化数据库结构

创建 SQL 迁移文件：

```sql
-- schema.sql
CREATE TABLE IF NOT EXISTS users (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  name TEXT NOT NULL,
  email TEXT UNIQUE NOT NULL,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE IF NOT EXISTS posts (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id INTEGER NOT NULL,
  title TEXT NOT NULL,
  content TEXT,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES users(id)
);

-- 插入示例数据
INSERT INTO users (name, email) VALUES 
  ('张三', 'zhangsan@example.com'),
  ('李四', 'lisi@example.com');
```

执行 SQL 文件：

```bash
# 本地数据库执行
wrangler d1 execute mydb --local --file=./schema.sql

# 远程数据库执行
wrangler d1 execute mydb --remote --file=./schema.sql
```

### 使用命令行查询

```bash
# 查询本地数据库
wrangler d1 execute mydb --local --command="SELECT * FROM users"

# 查询远程数据库
wrangler d1 execute mydb --remote --command="SELECT * FROM users"
```

## 在 Worker 中使用 D1

### TypeScript 类型定义

更新 `src/index.ts` 的 Env 接口：

```typescript
export interface Env {
  DB: D1Database;  // D1 数据库绑定
}

interface User {
  id: number;
  name: string;
  email: string;
  created_at: string;
}

interface Post {
  id: number;
  user_id: number;
  title: string;
  content: string;
  created_at: string;
}
```

### 基础 CRUD 操作

```typescript
export default {
  async fetch(request: Request, env: Env, ctx: ExecutionContext): Promise<Response> {
    const url = new URL(request.url);
    const path = url.pathname;

    try {
      // GET /users - 获取所有用户
      if (path === '/users' && request.method === 'GET') {
        const { results } = await env.DB.prepare(
          'SELECT * FROM users ORDER BY created_at DESC'
        ).all<User>();

        return Response.json({ success: true, data: results });
      }

      // GET /users/:id - 获取单个用户
      if (path.match(/^\/users\/\d+$/) && request.method === 'GET') {
        const id = path.split('/')[2];
        
        const user = await env.DB.prepare(
          'SELECT * FROM users WHERE id = ?'
        ).bind(id).first<User>();

        if (!user) {
          return Response.json({ error: 'User not found' }, { status: 404 });
        }

        return Response.json({ success: true, data: user });
      }

      // POST /users - 创建用户
      if (path === '/users' && request.method === 'POST') {
        const body = await request.json() as { name: string; email: string };

        const result = await env.DB.prepare(
          'INSERT INTO users (name, email) VALUES (?, ?)'
        ).bind(body.name, body.email).run();

        return Response.json({
          success: true,
          data: { id: result.meta.last_row_id }
        }, { status: 201 });
      }

      // PUT /users/:id - 更新用户
      if (path.match(/^\/users\/\d+$/) && request.method === 'PUT') {
        const id = path.split('/')[2];
        const body = await request.json() as { name?: string; email?: string };

        await env.DB.prepare(
          'UPDATE users SET name = COALESCE(?, name), email = COALESCE(?, email) WHERE id = ?'
        ).bind(body.name, body.email, id).run();

        return Response.json({ success: true });
      }

      // DELETE /users/:id - 删除用户
      if (path.match(/^\/users\/\d+$/) && request.method === 'DELETE') {
        const id = path.split('/')[2];

        await env.DB.prepare(
          'DELETE FROM users WHERE id = ?'
        ).bind(id).run();

        return Response.json({ success: true });
      }

      return Response.json({ error: 'Not found' }, { status: 404 });

    } catch (error) {
      console.error('Database error:', error);
      return Response.json({
        error: 'Internal server error',
        message: error instanceof Error ? error.message : 'Unknown error'
      }, { status: 500 });
    }
  },
};
```

### 复杂查询示例

```typescript
// 联表查询 - 获取用户及其文章
async function getUserWithPosts(env: Env, userId: string) {
  // 获取用户信息
  const user = await env.DB.prepare(
    'SELECT * FROM users WHERE id = ?'
  ).bind(userId).first<User>();

  if (!user) {
    return null;
  }

  // 获取用户的文章
  const { results: posts } = await env.DB.prepare(
    'SELECT * FROM posts WHERE user_id = ? ORDER BY created_at DESC'
  ).bind(userId).all<Post>();

  return {
    ...user,
    posts: posts
  };
}

// 分页查询
async function getPostsPaginated(env: Env, page: number, pageSize: number) {
  const offset = (page - 1) * pageSize;

  const { results } = await env.DB.prepare(`
    SELECT 
      posts.*,
      users.name as author_name,
      users.email as author_email
    FROM posts
    JOIN users ON posts.user_id = users.id
    ORDER BY posts.created_at DESC
    LIMIT ? OFFSET ?
  `).bind(pageSize, offset).all();

  return results;
}

// 事务处理
async function createPostWithTransaction(env: Env, userId: number, title: string, content: string) {
  // 批量执行多个语句
  const results = await env.DB.batch([
    env.DB.prepare('INSERT INTO posts (user_id, title, content) VALUES (?, ?, ?)')
      .bind(userId, title, content),
    env.DB.prepare('UPDATE users SET post_count = post_count + 1 WHERE id = ?')
      .bind(userId)
  ]);

  return results;
}
```

### 完整的 API 示例

```typescript
export interface Env {
  DB: D1Database;
}

interface User {
  id: number;
  name: string;
  email: string;
  created_at: string;
}

interface Post {
  id: number;
  user_id: number;
  title: string;
  content: string;
  created_at: string;
}

// 路由处理器
class Router {
  private routes: Map<string, (request: Request, env: Env) => Promise<Response>> = new Map();

  add(pattern: string, handler: (request: Request, env: Env) => Promise<Response>) {
    this.routes.set(pattern, handler);
  }

  async handle(request: Request, env: Env): Promise<Response> {
    const url = new URL(request.url);
    const path = url.pathname;
    const method = request.method;

    for (const [pattern, handler] of this.routes) {
      const regex = new RegExp(pattern.replace(/:\w+/g, '(\\w+)'));
      if (regex.test(path)) {
        return handler(request, env);
      }
    }

    return Response.json({ error: 'Not found' }, { status: 404 });
  }
}

const router = new Router();

// 获取所有用户
router.add('^/users$', async (request, env) => {
  if (request.method !== 'GET') {
    return Response.json({ error: 'Method not allowed' }, { status: 405 });
  }

  const { results } = await env.DB.prepare(
    'SELECT id, name, email, created_at FROM users ORDER BY created_at DESC'
  ).all<User>();

  return Response.json({ success: true, data: results });
});

// 创建用户
router.add('^/users$', async (request, env) => {
  if (request.method !== 'POST') {
    return Response.json({ error: 'Method not allowed' }, { status: 405 });
  }

  const body = await request.json() as { name: string; email: string };

  if (!body.name || !body.email) {
    return Response.json({ error: 'Missing required fields' }, { status: 400 });
  }

  try {
    const result = await env.DB.prepare(
      'INSERT INTO users (name, email) VALUES (?, ?)'
    ).bind(body.name, body.email).run();

    return Response.json({
      success: true,
      data: { id: result.meta.last_row_id }
    }, { status: 201 });
  } catch (error) {
    return Response.json({
      error: 'Failed to create user',
      message: error instanceof Error ? error.message : 'Unknown error'
    }, { status: 500 });
  }
});

// 获取用户的所有文章
router.add('^/users/\\d+/posts$', async (request, env) => {
  const url = new URL(request.url);
  const userId = url.pathname.split('/')[2];

  const { results } = await env.DB.prepare(`
    SELECT * FROM posts 
    WHERE user_id = ? 
    ORDER BY created_at DESC
  `).bind(userId).all<Post>();

  return Response.json({ success: true, data: results });
});

export default {
  async fetch(request: Request, env: Env, ctx: ExecutionContext): Promise<Response> {
    // CORS 处理
    if (request.method === 'OPTIONS') {
      return new Response(null, {
        headers: {
          'Access-Control-Allow-Origin': '*',
          'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',
          'Access-Control-Allow-Headers': 'Content-Type',
        }
      });
    }

    try {
      const response = await router.handle(request, env);
      
      // 添加 CORS 头
      response.headers.set('Access-Control-Allow-Origin', '*');
      return response;
    } catch (error) {
      console.error('Request error:', error);
      return Response.json({
        error: 'Internal server error',
        message: error instanceof Error ? error.message : 'Unknown error'
      }, { status: 500 });
    }
  },
};
```

## 本地开发

### 启动本地开发服务器

```bash
# 启动 dev 服务器（使用本地 D1）
pnpm run dev

# 或
wrangler dev --local

# 访问 http://localhost:8787
```

### 查看本地数据库

```bash
# 查询本地数据
wrangler d1 execute mydb --local --command="SELECT * FROM users"

# 使用 SQL 文件
wrangler d1 execute mydb --local --file=./queries.sql
```

### 测试 API

```bash
# 创建用户
curl -X POST http://localhost:8787/users \
  -H "Content-Type: application/json" \
  -d '{"name": "测试用户", "email": "test@example.com"}'

# 获取所有用户
curl http://localhost:8787/users

# 获取单个用户
curl http://localhost:8787/users/1

# 更新用户
curl -X PUT http://localhost:8787/users/1 \
  -H "Content-Type: application/json" \
  -d '{"name": "更新后的名字"}'

# 删除用户
curl -X DELETE http://localhost:8787/users/1
```

## 部署到生产环境

### 同步数据库结构到远程

```bash
# 执行迁移到远程数据库
wrangler d1 execute mydb --remote --file=./schema.sql
```

### 部署 Worker

```bash
# 部署到 Cloudflare
pnpm run deploy

# 或
wrangler deploy
```

### 查看部署信息

```bash
# 查看已部署的 Workers
wrangler deployments list

# 查看日志
wrangler tail
```

## D1 最佳实践

### 1. 使用参数化查询防止 SQL 注入

```typescript
// 错误示例（危险）
const query = `SELECT * FROM users WHERE email = '${email}'`;

// 正确示例
const result = await env.DB.prepare(
  'SELECT * FROM users WHERE email = ?'
).bind(email).first();
```

### 2. 批量操作优化性能

```typescript
// 使用 batch 进行批量操作
const statements = users.map(user => 
  env.DB.prepare('INSERT INTO users (name, email) VALUES (?, ?)')
    .bind(user.name, user.email)
);

await env.DB.batch(statements);
```

### 3. 索引优化查询

```sql
-- 为常用查询字段创建索引
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_posts_user_id ON posts(user_id);
CREATE INDEX idx_posts_created_at ON posts(created_at);
```

### 4. 分页查询

```typescript
async function getPaginatedUsers(
  env: Env,
  page: number = 1,
  limit: number = 20
) {
  const offset = (page - 1) * limit;
  
  const { results } = await env.DB.prepare(`
    SELECT * FROM users 
    ORDER BY created_at DESC 
    LIMIT ? OFFSET ?
  `).bind(limit, offset).all<User>();
  
  return results;
}
```

### 5. 错误处理

```typescript
try {
  const result = await env.DB.prepare(query).bind(...params).run();
  
  if (!result.success) {
    throw new Error('Query failed');
  }
  
  return result;
} catch (error) {
  console.error('Database error:', error);
  throw error;
}
```

## 环境隔离

### 配置多环境

```toml
# wrangler.toml
name = "my-api"
main = "src/index.ts"
compatibility_date = "2024-01-01"

# 开发环境
[env.dev]
[[env.dev.d1_databases]]
binding = "DB"
database_name = "mydb-dev"
database_id = "dev-database-id"

# 生产环境
[env.production]
[[env.production.d1_databases]]
binding = "DB"
database_name = "mydb"
database_id = "prod-database-id"
```

### 部署到不同环境

```bash
# 部署到开发环境
wrangler deploy --env dev

# 部署到生产环境
wrangler deploy --env production
```

## 监控和调试

### 查看实时日志

```bash
# 查看生产环境日志
wrangler tail

# 查看特定环境
wrangler tail --env production

# 过滤日志
wrangler tail --status error
```

### 数据库备份

```bash
# 导出数据
wrangler d1 execute mydb --remote --command="SELECT * FROM users" > users_backup.json

# 使用 SQL 导出
wrangler d1 backup create mydb
wrangler d1 backup list mydb
```

## 总结

通过 Cloudflare CLI 和 D1 数据库，你可以快速构建：
- RESTful API
- 全栈 Web 应用
- 数据驱动的边缘应用
- 实时数据处理服务

D1 的优势在于全球分布、低延迟和无服务器架构，非常适合需要快速响应的应用场景。

## 相关资源

- [Wrangler CLI 文档](https://developers.cloudflare.com/workers/wrangler/)
- [D1 数据库文档](https://developers.cloudflare.com/d1/)
- [D1 API 参考](https://developers.cloudflare.com/d1/platform/client-api/)
- [Cloudflare Workers 模板](https://developers.cloudflare.com/workers/get-started/guide/)


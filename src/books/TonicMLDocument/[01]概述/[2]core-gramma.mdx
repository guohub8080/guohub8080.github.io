export const title = "核心语法"

# {title}

## 状态管理机制

TonicML 维护一个智能的内置状态管理系统，所有音乐参数都有合理的默认值，用户只需在需要变更时进行显式设置。这种设计大大简化了简单乐谱的创建过程。


| 属性名称                     | 默认值 | 数据类型     | 说明                      |
| :--------------------------- | :----- | :----------- | :------------------------ |
| 基准八度（octave）           | 4      | 正整数       | 绝对八度值，中央C所在八度 |
| 演奏速度（bpm / tempo）        | 100    | 正整数或小数 | 每分钟节拍数              |
| 调式（key）                  | C大调  | 调性标记     | 音乐的调性基础            |
| 音符时值（quarterLength）    | 1      | 比值         | 相对四分音符的时值比例    |
| 节拍（beat / timeSignature）   | 4/4    | 分数形式     | 拍号设置，四四拍          |
| 谱表（clef）                 | treble | 谱表         | 谱号类型，高音谱号        |


状态管理遵循层次化继承原则：全局状态影响整个乐谱的基础设置，声部状态继承全局状态但可局部覆盖，局部状态则在小节或音符级别进行临时调整。

## 基本单位：音符构成系统

### 音符结构概述

音符是构成 TonicML 乐谱的核心单元。每个音符都是一个完整的信息包，包含音高、时值和可选的歌词信息。基本单位内部严禁出现空格，基本单位之间必须用至少一个空格分隔，支持灵活的元素组合顺序，所有元素必须紧密连接，形成不可分割的原子单位。

每个音符单元包含以下组成要素（按解析优先级排列）：

1. 音高核心（Pitch Core）：音高、变音记号与八度调整的组合
2. 时值（Duration）：紧跟音高核心，表示该音符持续时间
3. 歌词（Lyric）：可选项，始终位于基本单元末尾
4. 音符注释（Note Annotation）：可选项，为特定音符添加说明

### 音高表示系统

TonicML 创新性地兼容简谱和国际音名两套体系，满足不同文化背景和使用习惯的音乐创作者需求。

#### 双重表示体系

简谱数字系统使用 `1` 到 `7` 代表音阶中的各个音级，国际音名系统使用 `C, D, E, F, G, A, B` 表示绝对音名，不区分大小写，`A` 和 `a` 都表示同一个 A 音。


| 简谱数字 | 音级性质              | 音程关系 |
| :------- | :-------------------- | :------- |
| `1`      | 主音（Tonic）         | 纯一度   |
| `2`      | 上主音（Supertonic）  | 大二度   |
| `3`      | 中音（Mediant）       | 大三度   |
| `4`      | 下属音（Subdominant） | 纯四度   |
| `5`      | 属音（Dominant）      | 纯五度   |
| `6`      | 下中音（Submediant）  | 大六度   |
| `7`      | 导音（Leading Tone）  | 大七度   |

#### 转换核心原则

TonicML 遵循一致性转换原则，这是整个系统最重要的设计决策之一：所有简谱数字（`1`-`7`）始终映射到其根音对应的大调音阶音级。无论当前调式为大调还是小调，数字 `3`、`6`、`7` 在无变音记号时，永远代表大三度、大六度、大七度音程关系。

这种设计理念避免因调式变化产生的隐式音高变动，将音高解释的控制权完全交给用户，保证语法的明确性和无歧义性，便于编译器实现和维护。

#### 小调记谱方法

在小调环境中创作时，需要手动为相应音级添加变音记号以获得正确音高。示例：

- C 大调：`1 2 3 4 5 6 7` → `C D E F G A B`
- C 小调：`1 2 b3 4 5 b6 b7` → `C D Eb F G Ab Bb`

这种显式标记方法确保了音高解释的准确性和可预测性，不同调式间的语法一致性，以及编译器逻辑的简洁性。

### 变音记号系统

变音记号是精确调整音高的重要工具，TonicML 支持前置和后置两种写法，提供最大的输入灵活性。


| 记号     | 名称   | 音高效果       | 语法规则             | 示例                     |
| :------- | :----- | :------------- | :------------------- | :----------------------- |
| `#`      | 升号   | 升高半音       | `#音高` 或 `音高#`   | `#4`、`4#`（升Fa）       |
| `b`      | 降号   | 降低半音       | `b音高` 或 `音高b`   | `b7`、`7b`（降Si）       |
| `n`      | 还原号 | 还原到自然音高 | `n音高` 或 `音高n`   | `n4`、`4n`（还原Fa）     |
| `##`/`x` | 重升号 | 升高全音       | 支持四种写法         | `x4`、`##4`、`4x`、`4##` |
| `bb`     | 重降号 | 降低全音       | `bb音高` 或 `音高bb` | `bb7`、`7bb`             |

强制性规则：音高与变音记号必须紧密相连，不允许中间插入其他符号，变音记号的数量和类型必须明确。

解析示例与注意事项：`b` 解析为音符B，`bb`或`Bb` 解析为音符B♭，`bbb` 解析为音符B♭♭，而 `bBb` 会导致编译器报错。

### 休止符系统

休止符表示音乐中的静默段落，在 TonicML 中使用统一的 `0` 符号表示，其时值规则与普通音符完全相同。常见示例包括：`0`（四分休止符）、`0-`（八分休止符）、`0.`（附点四分休止符）、`0++`（全休止符）。

### 八度临时移动标记

八度标记是TonicML的创新设计，允许灵活地调整音符的八度位置，相对于基准八度进行精确控制。


| 记号 | 名称   | 效果             | 示例                |
| :--- | :----- | :--------------- | :------------------ |
| `>`  | 高八度 | 比基准高一个八度 | `>1`、`>>1`、`>>>1` |
| `<`  | 低八度 | 比基准低一个八度 | `<7`、`<<7`、`<<<7` |

八度标记具有位置灵活性（可置于音符前后任意位置）、无限叠加性（支持无限次叠加以实现极端音区的表达）和语义明确性（每个符号代表一个八度的移动）。

实例演示：`1`（第4个八度的Do），`<Eb`（第3个八度的E♭），`>#G`（第5个八度的G♯），`>>6`（第6个八度的La），`<<<b3`（第1个八度的E♭）。

### 时值系统

时值系统是TonicML音乐表达的核心组件，采用四分音符为基准单位的递归修饰设计。


| 音符名称     | 时值关系  | 语法标记    | 数值比例   | 示例              |
| :----------- | :-------- | :---------- | :--------- | :---------------- |
| 四分音符     | 基准      | 无符号      | 1.0        | `3`（四分音符Mi） |
| 八分音符     | 减半      | `-`         | 0.5        | `3-`、`0-`        |
| 十六分音符   | 再减半    | `--` 或 `=` | 0.25       | `3--`、`3=`       |
| 三十二分音符 | 三次减半  | `---`       | 0.125      | `3---`            |
| 附点音符     | 延长1.5倍 | `.`         | 原时值×1.5 | `3.`、`3-.`       |
| 二分音符     | 翻倍      | `+`         | 2.0        | `3+`              |
| 全音符       | 四倍      | `++`        | 4.0        | `3++`             |
| 倍全音符     | 八倍      | `+++`       | 8.0        | `3+++`            |

时值修饰符可以组合使用，遵循从左到右的计算顺序：`3+.`（附点二分音符）、`3-.`（附点八分音符）、`3--.`（附点十六分音符）。

### 歌词标记系统

歌词标记为声乐作品提供了文字内容的精确对应关系。语法为 `音符{歌词}`，支持一对一对应（`1{你} 2{好}`）和一对多对应（`1{谢谢你}`）。歌词内容支持中文、英文及其他Unicode字符，歌词长度不受限制，但建议保持简洁。

### 注释系统

TonicML的注释系统分为音符注释和普通注释两大类型。音符注释与特定音符紧密绑定，用于演奏法指导，普通注释则是独立的说明信息，用于整体描述。


| 注释类型     | 语法特征     | 示例            | 说明                             |
| :----------- | :----------- | :-------------- | :------------------------------- |
| 音符注释     | 无空格连接   | `3.{你}@{重音}` | 与音符紧密相连，既带歌词又有注释 |
| 前置音符注释 | 紧贴音符前方 | `@{轻柔}1`      | 前置演奏指导                     |
| 普通注释     | 与音符分离   | `1 @{换气} 2`   | 一般性说明                       |

选择 `@{...}` 作为注释语法是为了避免与音乐符号冲突。在传统编程语言中，`#` 常用作注释符，但在音乐记谱中，`#` 是不可替代的升号符号。

### 元素组合规则与最佳实践

强制性组合规则：

- 音高与变音记号必须相邻，前后顺序均可
- 音高-变音记号组合中间不能插入其他元素
- 同一音符的所有元素必须紧密连接，无空格分隔

推荐组合顺序：

- 国际音名：八度移动标记 → 音高 → 变音记号 → 时值符号 → 歌词 → 音符注释
- 简谱数字：八度移动标记 → 变音记号 → 音高 → 时值符号 → 歌词 → 音符注释

示例：`>Eb.{hello}@{annotation}`和`<#1.{你}@{重音}`

## 特殊音符标记系统

### 和音/同时演奏标记

和音标记用于表示需要同时发声的多个音符，是多声部音乐和和声表现的重要工具。

基本语法结构：`&c<时值>{音符列表}` 或 `&C<时值>{音符列表}`，其中 `c` 代表和弦（Chord）的缩写，时值符号可选（默认为四分音符），大括号内列出所有同时演奏的音符。


| 示例           | 说明      | 音符构成     | 时值         |
| :------------- | :-------- | :----------- | :----------- |
| `&c{1 3 5}`    | C大三和弦 | Do-Mi-Sol    | 四分音符     |
| `&c.{1 3b 5}`  | 小三和弦  | Do-♭Mi-Sol   | 附点四分音符 |
| `&c={1 5}`     | 五度音程  | Do-Sol       | 十六分音符   |
| `&c+{1 3 5 7}` | 七和弦    | Do-Mi-Sol-Si | 二分音符     |

时值统一原则：和音内部的音符时值以外部标记为准。如果内部音符包含时值标记将被忽略，编译器发出警告。

### 延音与连奏系统

延音与连奏是音乐表现力的重要组成部分，TonicML提供了原生语法和语法糖两种方式。

#### 原生语法：起止标记法

语法结构：开始标记 `&ts{...}`（tie start），结束标记 `&te{...}`（tie end）。

功能区分：

- 延音线（Tie）：相同音高时，将时值相加成一个长音
- 连奏线（Slur）：不同音高时，表示圆滑演奏
- 跨小节连线：可跨越小节线，编译器维持跨小节状态


#### 语法糖：圆括号连奏法

推荐语法：使用 `(...)` 替代原生语法，更加简洁直观。

示例：`(1 1-)`（附点四分音符时长的Do）、`(1 2 3 4)`（圆滑演奏Do-Re-Mi-Fa）、`1 2 3 (4 ; 4) 5 6 7`（跨小节连接两个Fa）。

状态机制：`(` 开启连奏状态，`)` 关闭连奏状态，支持跨行、跨小节的状态维持，未闭合的括号不会导致编译错误。

### 倚音系统

倚音是装饰性的快速音符，为主要音符添加表现力。

基本语法：`&G{倚音组 ~ 目标音}` 或 `&g{倚音组 ~ 目标音}`，其中 `G` 代表装饰音（Grace note），`~` 符号分隔倚音与目标音，倚音不占用主体时值。

示例：`&G{1 2 ~ 3.}`（双倚音到附点四分音符Mi）、`&G{7 ~ 1+}`（单倚音到二分音符Do）。

重要提示：倚音部分的时值标记会被自动忽略，编译器会对倚音中的时值标记发出警告，只有目标音的时值标记有效。

### 连音系统

连音用于表示三连音、五连音等不规则节奏分组，是复杂节奏表现的重要工具。

基本语法：`&t<时值>{音符列表}`，其中 `t` 代表连音（Tuplet），时值符号定义整个连音组合的总时值，音符列表中的音符平均分配总时值。


| 连音类型   | 示例             | 总时值       | 单音符时值     | 说明       |
| :--------- | :--------------- | :----------- | :------------- | :--------- |
| 三连音     | `&t{3 3 3}`      | 四分音符     | 四分音符÷3     | 标准三连音 |
| 附点三连音 | `&t.{3 3 3}`     | 附点四分音符 | 附点四分音符÷3 | 较长三连音 |
| 快速三连音 | `&t-{3 3 3}`     | 八分音符     | 八分音符÷3     | 快速三连音 |
| 五连音     | `&t+{5 5 5 5 5}` | 二分音符     | 二分音符÷5     | 五等分连音 |

严格规则：音符列表中不应包含时值标记，连音标记本身不支持八度调整，如需八度调整必须对每个音符单独设置。

## 结构化组织系统

### 小节组织与管理

小节是音乐节奏组织的基础单位，TonicML提供了灵活而严格的小节管理机制。

#### 小节基本概念与验证

在标准四四拍中，以四分音符为一拍，每小节需要4拍才能通过编译器的合法性验证。编译器会自动检查每个小节的拍数是否符合当前拍号要求。

#### 小节分隔规则

行内多小节必须使用逗号分隔（`1 2 3 4 , 2 3 4 5`），跨行小节换行时可省略逗号。错误用法如 `1 2 3 4 2 3 4 5` 会被编译器视为8拍的违规小节。

#### 小节标记系统

标记语法：`@M{...}` 或 `@m{...}`（Measure的缩写）或`@measure{...}`

使用规则：必须在行首使用，标记范围为紧随其后的一个小节，小节结束后标记效果自动失效，支持多重注释叠加。

```tonicml
@M{弱起小节，注意不要抢拍}
0 0 0 1

@M{第一个完整小节}
1 2 3 4

@M{渐强小节}
@M{注意力度变化}
2 3 4 5
```


### 乐句结构管理

乐句是包含若干小节的逻辑性"音乐话语"，在音乐结构层次上高于小节，用于表达完整的音乐思想。乐句通常包含完整的旋律线条、和谐的节奏模式、统一的情感表达和明确的起承转合。

#### 乐句分割机制

分号分割法使用分号 `;` 显式分割不同乐句，自然分割法则是没有分号时，所有小节视为一个乐句。

#### 乐句标记系统

标记语法：`@phrase{...}` 或 `@ph{...}`或`@f{...}`

特别声明：乐句的专业术语应该叫phrase，但因为单字母 `p` 已被和声部（part）标识符占用，为避免语法冲突，我们采用 `f` （乐句，旋律行）来作为缩写。

标记规则：必须在行首使用，标记范围为其后的完整乐句，直到下一个 `@f{...}` 或 `;` 为止，支持自动语义隔断识别。

```tonicml
@f{第一行：温柔的开始}
1 2 3 3, 1 3 3 3, 6 6 4 5

@f{第二行：情感的升华}
1 2 3 3, 4 4 4 5
```


#### 小节与乐句的层次关系

完整结构示例展现了小节与乐句的协作关系：

```tonicml
@Ph{第一行，男声领唱}
@M{弱起小节}
0 0 0 1

@M{第一个完整小节}
1 2 3 3, 1 3 3 3, 6 6 4 5 @{注意，小节注释只影响第一个小节，后面的都不影响}

@Ph{第二行，女声应答}
@M{力度对比小节}
1 2 3 3, 4 4 4 5, 6 6 6 6, 5 4 2 1 ;
```

当出现新的乐句标记时，即使前一个小节没有显式的分隔符，编译器也会自动识别语义边界。

### 和声标记系统

和声标记是TonicML的重要创新功能，用于在乐谱上标记和声背景，为音乐分析和演奏提供重要信息。

#### 和声标记的音乐学意义

和声标记不作为演奏指令，而是描述性标记，用于分析音乐的和声进行、指导即兴演奏、辅助音乐教学和为AI音乐分析提供语义信息。

#### 基本语法系统

原生语法：`@C{...}` 或 `@c{...}`（Chord的缩写）

和声标记单独成一章，请见[链接]。

#### 和声标记的位置与作用

- 小节基础和弦：置于小节开始处，设定默认和声（`@C{C} 1 2 3 4`）
- 小节内精确和弦：置于任意音符前，立即覆盖当前和声（`@C{C} 1 2 @C{G7} 3 4`）
- 复合和声示例：`@C{Dm7} 1 1 @C{G7} 2 2 @C{Cmaj7} 3 3 @C{Am} 4 4`


#### 语法糖与特殊标记

推荐语法糖：使用 `[...]` 替代 `@C{...}`，具有更简洁直观的视觉效果，避免与音名C的视觉混淆，更符合现代音乐软件的习惯。

TonicML支持两类特殊和声标记：

- 无和弦标记：用于明确表示此处无和声背景，可使用 `[x]`、`[X]`、`[null]`、`[none]`、`[blank]`、`[undefined]`、`[void]`、``、`[no]` 等任意一种标记
- 不确定和声标记：用 `[?]` 表示此处和声性质不明或待定

重要提示：和声标记仅为语义标注，不具备小节分割功能。无论是否使用和声标记，同一行内的多个小节之间都必须使用逗号 `,` 进行明确分割。和声标记与小节分割是两个独立的语法层面，不可混淆或相互替代。示例如下。

```tonicml
@M{自由节拍的引子}
[x] 0 0 0 1 , [?] 1 2 3 [Dm] 4

@M{明确和声的主题}
[F] 1 1 [C] 2 2 , [Dm] 3 3 [G] 4 4
```


### 段落标记系统

段落标记用于组织大型乐曲的结构框架，是音乐作品宏观结构管理的重要工具。

#### 段落标记的音乐功能

用于标识音乐作品的结构性段落：intro（前奏部分）、verse（主歌部分）、chorus（副歌部分）、bridge（过渡段落）、outro（尾声部分）、solo（独奏段落）等。编译器对段落标识术语不执行合法性校验，用户可以根据创作需要自由定义段落名称，如 `coda`（尾声）、`interlude`（间奏）、`breakdown`（分解段）等，或使用中文标识如"间奏"、"华彩段"等，以适应不同音乐风格和创作习惯的表达需求。

#### 段落标记语法与作用域

基本语法：`@section{...}`、`@sec{...}`、`@s{...}`、`@S{...}`，必须单独成行书写

作用域规则：从当前位置到下一个段落标记或声部结束

```tonicml
@section{intro:神秘的前奏}
0 0 0 1, 1 2 3 4, 5 5 5 5

@section{verse1:第一段叙述}  
1 1 2 3, 3 2 1 0, 4 4 5 6, 6 5 4 0

@s{chorus - 激昂的副歌}
5 5 6 7, 7 6 5 4, 3 3 4 5, 5 4 3 0
```


#### 多层次结构组合与自动缩进

段落标记可以与乐句、小节标记形成完整的层次体系：

```tonicml
@S{verse1 - 温柔的叙述段}
@ph{第一行：如诗般的开始}
1 1 5 5
6 6 5+

@ph{第二行：情感的流淌}
@M{注意呼吸控制}
4 4 3 3
2 2 1+
```

支持TonicML插件的编辑器会根据结构标记自动进行缩进，使用空格而非Tab字符，缩进数量不影响语义解析，仅用于提升视觉可读性，示例如下。

```
@S{verse1 - 第一段主歌}
  @ph{轻柔地，一闪一闪亮晶晶}
    1 1 5 5, 6 6 5+

  @ph{欢快，漫天都是小星星}
    @M{这一小节不要有换气声音}
    4 4 3 3
    2 2 1+

@S{chorus - 副歌部分}
  @ph{第二遍，一闪一闪亮晶晶}
    1 1 5 5
    6 6 5+
```

#### 段落标记语法糖 (Section Marker Syntax Sugar)

我们为最常用的结构元素——段落标记 (`@section`)——提供了一套功能强大且直观的语法糖。该系统以 `@~` 为前缀，作为 `@section` 的直接快捷方式。它的设计目标是在满足标准标签极速输入的同时，也能优雅地处理带详细描述的复杂场景。核心语法为：

   - 简单标签模式：对于标准的、单次出现的段落，语法为 `@~<标签>`。
     - 示例：`@~intro` 完全等价于 `@section{intro}`。
   - 带描述的标签模式：如需为段落附加一段人类可读的详细描述，可在标签后紧跟花括号 `{}`。
     - 示例：`@~intro{一个神秘的开端}` 完全等价于结构化的 `@section{intro: 一个神秘的开端}`。编译器会智能地将 `intro` 解析为该段落的类型，并将"一个神秘的开端"解析为其描述。

`@~` 语法糖可用于任何自定义的标签（例如 `@~verse1`, `@~guitarsolo`）。下表整理了一系列常用音乐术语，它们都是该快捷语法的理想使用对象。

| `@~` 快捷指令  | 音乐术语     | 中文常用释义                          |
| :------------- | :----------- | :------------------------------------ |
| `@~intro`      | Introduction | **前奏**                              |
| `@~verse`      | Verse        | **主歌**                              |
| `@~prechorus`  | Pre-Chorus   | **前副歌** (或“导歌”)                 |
| `@~chorus`     | Chorus       | **副歌**                              |
| `@~postchorus` | Post-Chorus  | **后副歌**                            |
| `@~bridge`     | Bridge       | **桥段**                              |
| `@~solo`       | Solo         | **独奏**                              |
| `@~interlude`  | Interlude    | **间奏**                              |
| `@~breakdown`  | Breakdown    | **分解段**                            |
| `@~buildup`    | Build-up     | **堆积段** (情绪上升部分)             |
| `@~drop`       | Drop         | **高潮点** (常用于电子音乐)           |
| `@~hook`       | Hook         | **钩子** (指乐曲中最吸引人的片段)     |
| `@~riff`       | Riff         | **重复段** (通常指器乐主导的重复乐句) |
| `@~vamp`       | Vamp         | **固定和弦反复段**                    |
| `@~theme`      | Theme        | **主题** (如A段、B段)                 |
| `@~variation`  | Variation    | **变奏**                              |
| `@~coda`       | Coda         | **尾声** (补充性的结束部分)           |
| `@~outro`      | Outro        | **尾奏** (与前奏呼应的结束部分)       |

## 使用示例与最佳实践

此系统的强大之处在于其灵活性。

- 标签无空格：紧跟在 `@@` 后的标签必须是不含空格的连续字符串。`@~verse1` 是合法的，但 `@~verse 1` 会导致解析错误。
- 花括号可选：用于添加描述的花括号 `{...}` 是完全可选的。仅当您需要为自己或下游的AI工具添加额外上下文时才使用它。
- 可读性优先：这套语法糖旨在让您的音乐代码更整洁。善用它来增强、而不是模糊您作品的结构。

## 声部命令与多声部管理

### 声部系统的设计理念

#### 一声部一谱表原则

TonicML 遵循一个声部（Part）只拥有一个谱表（Staff）的核心原则。这种设计清晰反映管弦乐队或合唱团中每个乐手的乐谱角色，简化复杂音乐作品的结构管理，便于编译器处理和格式转换，符合传统音乐记谱的逻辑习惯。

#### 功能性命令vs描述性注释的区别

声部定义使用 `$` 而非 `@` 符号的原因在于功能本质的区别：

描述性注释（`@`）：为已存在的音乐信息附加描述，不改变编译器的解析行为，移除后乐谱的音乐内容依然完整，用于人类阅读和理解。

功能性命令（`$`）：直接控制编译器的内部状态，改变后续内容的解析和归属，影响最终编译结果的结构，执行实际的操作指令。

### 声部定义与管理

#### 声部定义语法

基本语法：`$part{...}`、`$P{...}`、`$p{...}`

作用域：当前声部的所有内容，直到遇到下一个声部定义

当编译器遇到 `$p{bass}` 时，它执行的是切换操作：将当前"写入"轨道从（例如）`melody` 切换到 `bass`，此后所有音符都定向到新的声部上下文中。

### 声部注释系统

#### 显式声部注释

专用语法：`@part{...}`，作用域为当前声部的所有内容，用途为声部专属的演奏指导、乐器说明。

#### 语法糖：自动声部注释

在满足特定规则的情况下，无需`@part`，而只需`@`即可被自动解释为声部注释：

1. 必须在在声部命令`$part`后出现的`@`；
2. 必须在其他标记之前，如`@phrase`、`@measure`等；
3. 在第一个音符出现前，如果没有其他标记，所有`$part`后的 `@{}` 普通注释会被编译器自动解释为声部注释。

### 声部属性系统（高级功能）

#### 声部属性的设计目标

声部属性命令完全可选，主要用于兼容MusicXML格式导出、提供详细的乐器和MIDI信息、满足专业音乐制作需求和支持高级音频处理。

#### 键值对语法系统

核心语法：`$p.属性{值}`（`$p`可等效替换为`$part`、`P`）

这个设计提供完全可扩展的框架，允许用户精确定义声部在各种目标格式中需要的任何属性。

如果使用该命令，必须在此之前有一个`$part`命令，否则会报错：“必须在$part命令后才能对该部分进行声部属性设置”。

#### 常用声部属性对照

| TonicML命令             | MusicXML对应概念      | 参数范围   | 说明                      |
| :---------------------- | :-------------------- | :--------- | :------------------------ |
| `$p.name{Violin I}`     | `<part-name>`         | 文本字符串 | 声部完整显示名称          |
| `$p.abbr{Vln. I}`       | `<part-abbreviation>` | 文本字符串 | 声部缩写名称（续页使用）  |
| `$p.instrument{Violin}` | `<instrument-name>`   | 乐器名称   | 主要乐器标识              |
| `$p.midi-channel{1}`    | `<midi-channel>`      | 1-16       | MIDI通道分配              |
| `$p.midi-program{41}`   | `<midi-program>`      | 0-127      | MIDI音色库ID（41=小提琴） |
| `$p.volume{90}`         | `<volume>`            | 0-127      | 声部音量控制              |
| `$p.pan{-60}`           | `<pan>`               | -180到180  | 立体声声像位置            |

注：上述内容对`$P`、`$PART`、``$part`是等价的。

### 声部系统行为规则

#### 默认声部与多声部对齐

单声部模式：如果乐谱中没有定义任何声部标记，所有内容默认属于同一个匿名声部，会被自动分配默认名称和属性。

长度对齐机制：当定义多个声部时，编译器自动进行长度对齐，以最长声部为基准长度，在较短声部末尾自动填充等长休止符，确保所有声部导出时长度完全一致，保证多声部音乐的时间同步。

#### 作用域管理规则

内容归属：所有在 `$p{...}` 命令后出现的内容都归属该声部，包括音乐内容（音符、休止符等）、结构标记（小节、乐句、段落）、注释和说明、局部命令和设置。

状态继承：新声部自动继承全局状态，可进行局部覆盖。声部属性设置立即对当前活动声部生效。

## 全局控制命令系统

### 元数据管理

#### 元数据设计理念

TonicML采用简化元数据管理的设计理念，摒弃MusicXML中过度细分的复杂分类体系，专注于音乐创作的核心信息需求。

#### 核心元数据标记

需要在文件开头处填写，不区分顺序。如果多次声明，则在编译时以最新覆盖的原则进行。

| 标记                   | 用途      | 数据类型   | 说明                                     |
| :--------------------- | :-------- | :--------- | :--------------------------------------- |
| `$title{}`             | 作品标题  | 文本字符串 | 文件名或歌曲名，一个.tml文件对应一首歌曲 |
| `$style{}`或`$genre{}` | 曲风/流派 | 文本字符串 | 编译器不验证格式                         |
| `$author{}`            | 统一作者  | 文本字符串 | 不区分作词、作曲的统一标记               |
| `$date{}`              | 时间记录  | 时间字符串 | 支持日期或日期时间，编译器不验证格式     |

设计原则：统一作者概念避免作词、作曲、编曲的复杂区分，简化协作项目的信息管理，专注于音乐内容而非制作流程。时间记录具有灵活性，支持任意格式的时间表示，编译器不进行时间格式验证，用户可根据需要选择精度和格式。

### 调性命令系统

#### 调性系统设计理念

TonicML使用统一而强大的调性命令，对简谱和五线谱用户提供相同的功能体验，确保调性设置的一致性和可预测性。

#### 调性命令语法与规则

基本命令形式：`$key{调性}`、`$K{调性}`、`$k{调性}`

调性标记规则：

- 基本音名：必须是 `C, D, E, F, G, A, B` 中的一个，不区分大小写输入，代表调性的根音
- 变音记号约束：仅支持升号（`#`）、降号（`b`），不支持重升号（`##`/`x`）、重降号（`bb`），位置灵活（可放在音名前后，必须相邻），不允许混合使用不同类型的变音记号
- 调式标记：大调无需额外标记（默认），小调在末尾添加 `m`

合法调性标记：`$key{C}`、`$K{f#}`、`$k{Bb}`、`$key{eb}`、`$K{am}`、`$k{F#m}`

简谱用户友好别名：`$key{1=C}` 完全等价于 `$key{C}`，迎合简谱用户的传统习惯。

#### 调性作用域管理

无声部环境的全局设置：在第一个乐句标记前或第一个小节开始前的调性设置作为全局默认。示例如下。

```
$title{E♭大调小星星}
$key{Eb}                    @{全局调性设置：降E大调}

@ph{开始演奏}
>1 1 5 5, 6 6 5+ ;         @{所有音符都遵循E♭大调}
```

多声部环境的全局继承：在第一个声部标记前的调性设置为全局调性。示例如下。

```
$title{多声部调性管理}
$k{G}                       @{全局调性：G大调}

$P{旋律声部}
1 1 5 5                     @{继承全局调性，1=G}

$P{低音声部}                @{同样继承全局调性}
1 1 1 1                     @{1=G}
```

声部独立调性控制：声部可以覆盖全局调性设置，实现声部独立的调性控制。

```
$title{声部调性独立设置}
$k{C}                       @{全局调性：C大调}

$P{旋律声部}
$k{D}                       @{声部专属调性：D大调}
1 2 3 4                     @{1=D, 2=E, 3=F#, 4=G}

$P{低音声部}                @{继承全局调性}
1 2 3 4                     @{1=C, 2=D, 3=E, 4=F}

$P{和声声部}
$k{Am}                      @{声部专属调性：A小调}
1 2 b3 4                    @{1=A, 2=B, b3=C, 4=D}
```

中途转调功能：TonicML支持在乐曲任何位置插入调性命令，实现平滑的转调效果。示例如下。

```
$title{中途转调示例}
$key{C}                     @{开始调性：C大调}

[C] 1 2 3 4                 @{C大调部分}
5 6 7 1

$k{G}                       @{转调命令：转到G大调}
[G] 1 2 3 4                 @{G大调部分，1=G}
5 6 7 1

$k{F}                       @{再次转调：转到F大调}
[F] 1 2 3 4                 @{F大调部分，1=F}
```

转调命令立即生效，从插入位置开始改变调性，影响后续所有音符的调性解释，直到遇到下一个转调命令为止，支持任意复杂的转调序列。

```
1 2 3 4 , 5 6 7 1           @{C大调开始}
$k{Am} 1 2 b3 4             @{转A小调}
$k{F} 1 2 3 4               @{转F大调}
$k{G} 5 6 7 1               @{转G大调结束}
```


### 基准八度设置系统

#### 八度系统概念

基准八度定义了音符的默认八度位置，在标准钢琴键盘上，中央C位于第4个八度。TonicML的八度系统为音符提供了精确的音高定位。

#### 八度命令语法与作用域

基本命令：`$octave{八度数值}`、`$O{八度数值}`、`$o{八度数值}`，参数要求八度数值必须为正整数。

八度作用域层次：

- 全局基准八度：文件开头的设置作为所有声部的全局基准
- 声部专属八度：在声部声明后设置，为该声部设定独立的八度基准，特别适合低音或高音乐器
- 动态八度调整：允许在声部内任何位置动态插入命令，实现对默认八度的即时调整

八度调整特性：调整命令立即生效，影响后续所有音符，乐句分割不会重置八度设置，支持任意次数的动态调整。

现在，我们可以给出声部变量隔离特性的正确示例：

#### 变量隔离特性

每个声部之间实现完全的变量隔离：每个声部仅继承全局变量，声部内的设置变更不影响其他声部，包括谱号、八度基准、调性等所有音乐参数。

```tonicml
$P{旋律声部}
$octave{5}      @{只影响当前声部}
1 2 3 4
1 1 1 1 

$P{低音声部}
$octave{3}      @{独立设置，不受上一声部影响}
1++
1++
```


### 谱表命令系统

#### 谱表系统设计

基于一声部一谱表的设计原则，每个声部可以独立指定其谱号类型，满足不同乐器和音域的显示需求。

#### 谱表命令语法与支持的谱号类型

基本命令：`$clef{谱号类型}`


| 推荐名称     | 别名选项                     | MusicXML对应  | 适用乐器范围                                     |
| :----------- | :--------------------------- | :------------ | :----------------------------------------------- |
| `treble`     | `g`, `G`, `h`, `H`           | G谱号         | 默认谱号。小提琴、长笛、吉他、高音人声、钢琴右手 |
| `bass`       | `f`, `F`, `l`, `L`, `b`, `B` | F谱号         | 大提琴、低音提琴、长号、贝斯、低音人声、钢琴左手 |
| `alto`       | `c`, `C`, `m`, `M`, `a`, `A` | C谱号（中音） | 中提琴、英国管                                   |
| `percussion` | `p`, `P`, `neutral`, `drum`  | 无音高谱号    | 打击乐器、节奏乐器                               |

#### 谱表作用域管理

全局谱表设置：在第一个声部声明前或第一个小节开始前设置，作为全局默认。

声部专属谱表：在声部声明后立即设置，定义该声部的专属谱表。

动态谱表切换：允许在声部内部动态切换谱表，切换谱表只改变音符在谱表上的显示位置，不影响实际音高或默认八度基准。

### 速度与拍号命令

#### 速度命令

语法：`$bpm{数字}`或`$tempo{数字}`，两种写法完全等价，支持整数和小数。

应用范围：支持全局设置（在文件开头或第一个声部前设置，作为整首乐曲的基础速度）和中途变速（允许在乐曲中间插入速度命令，实现渐快、渐慢等音乐表现）。

#### 拍号命令

语法：`$beat{x/y}`或`$time{x/y}`，表示以y分音符为一拍，每小节x拍。

常见拍号：`4/4`（四四拍）、`3/4`（三四拍）、`6/8`（六八拍）、`2/2`（二二拍）等。

重要特性：

- 合法性检验：影响对小节的合法性检验，每小节必须满足拍号要求
- 独立成行：拍号命令必须单独写一行，无论是全局设置还是中途换拍
- 即时生效：中途换拍号立即影响后续小节的验证

